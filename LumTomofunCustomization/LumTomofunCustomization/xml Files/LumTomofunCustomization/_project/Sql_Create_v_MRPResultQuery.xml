<Sql TableName="Create_v_MRPResultQuery" SqlScriptPriority="2" CustomScript="#CDATA">
    <CDATA name="CustomScript"><![CDATA[IF EXISTS
(
	SELECT *
	FROM SYS.views
	WHERE name = 'v_MRPResultQuery' AND SCHEMA_ID = SCHEMA_ID('dbo')
)
DROP VIEW [dbo].[v_MRPResultQuery]	
GO
CREATE VIEW v_MRPResultQuery AS
-- Forecase
SELECT MRPType,
	   item.InventoryCD AS SKU,
	   comp.CompanyCD AS Company,
	   comp.CompanyCD AS Country,
	   insite.SiteCD  AS Warehouse,
	   Date,
	   Qty
FROM LUMForecaseUpload forecase
INNER JOIN Company comp  ON forecase.CompanyID = comp.CompanyID
INNER JOIN INSite insite ON forecase.CompanyID = insite.CompanyID
						AND forecase.Warehouse = insite.SiteID
INNER JOIN InventoryItem item ON forecase.CompanyID = item.CompanyID
							 AND forecase.SKU = item.InventoryID
WHERE forecase.CompanyID > 0
-- MRP Result (Open SO Date-1)
UNION
SELECT 'OPEN SO(Date-1)' AS MRPType,
	   item.InventoryCD AS Sku,
	   comp.CompanyCD AS Company,
	   comp.CompanyCD AS Country,
	   insite.SiteCD  AS Warehouse,
	   Date,
	   PastOpenSo AS Qty
FROM LUMMRPProcessResult result
INNER JOIN Company comp  ON result.CompanyID = comp.CompanyID
INNER JOIN INSite insite ON result.CompanyID = insite.CompanyID
						AND result.Warehouse = insite.SiteID
INNER JOIN InventoryItem item ON result.CompanyID = item.CompanyID
							 AND result.SKU = item.InventoryID
WHERE result.PastOpenSo is not null and result.CompanyID > 0
-- MRP Result (Forecase Initial)
UNION
SELECT 'Forecase Initial' AS MRPType,
	   item.InventoryCD AS Sku,
	   comp.CompanyCD AS Company,
	   comp.CompanyCD AS Country,
	   insite.SiteCD  AS Warehouse,
	   Date,
	   ForecastIntial AS Qty
FROM LUMMRPProcessResult result
INNER JOIN Company comp  ON result.CompanyID = comp.CompanyID
INNER JOIN INSite insite ON result.CompanyID = insite.CompanyID
						AND result.Warehouse = insite.SiteID
INNER JOIN InventoryItem item ON result.CompanyID = item.CompanyID
							 AND result.SKU = item.InventoryID
WHERE result.ForecastIntial is not null and result.CompanyID > 0
-- MRP Result (SotckInitial)
UNION
SELECT 'Stock Initial' AS MRPType,
	   item.InventoryCD AS Sku,
	   comp.CompanyCD AS Company,
	   comp.CompanyCD AS Country,
	   insite.SiteCD  AS Warehouse,
	   Date,
	   StockInitial AS Qty
FROM LUMMRPProcessResult result
INNER JOIN Company comp  ON result.CompanyID = comp.CompanyID
INNER JOIN INSite insite ON result.CompanyID = insite.CompanyID
						AND result.Warehouse = insite.SiteID
INNER JOIN InventoryItem item ON result.CompanyID = item.CompanyID
							 AND result.SKU = item.InventoryID
WHERE result.StockInitial is not null and result.CompanyID > 0
-- MRP Result (Demand)
UNION
SELECT 'Demand' AS MRPType,
	   item.InventoryCD AS Sku,
	   comp.CompanyCD AS Company,
	   comp.CompanyCD AS Country,
	   insite.SiteCD  AS Warehouse,
	   Date,
	   Demand AS Qty
FROM LUMMRPProcessResult result
INNER JOIN Company comp  ON result.CompanyID = comp.CompanyID
INNER JOIN INSite insite ON result.CompanyID = insite.CompanyID
						AND result.Warehouse = insite.SiteID
INNER JOIN InventoryItem item ON result.CompanyID = item.CompanyID
							 AND result.SKU = item.InventoryID
WHERE result.Demand is not null and result.CompanyID > 0
-- MRP Result (StockAva)
UNION
SELECT 'Stock Ava.' AS MRPType,
	   item.InventoryCD AS Sku,
	   comp.CompanyCD AS Company,
	   comp.CompanyCD AS Country,
	   insite.SiteCD  AS Warehouse,
	   Date,
	   StockAva AS Qty
FROM LUMMRPProcessResult result
INNER JOIN Company comp  ON result.CompanyID = comp.CompanyID
INNER JOIN INSite insite ON result.CompanyID = insite.CompanyID
						AND result.Warehouse = insite.SiteID
INNER JOIN InventoryItem item ON result.CompanyID = item.CompanyID
							 AND result.SKU = item.InventoryID
WHERE result.StockAva is not null and result.CompanyID > 0
-- Inventory Allocate Details
UNION
SELECT LUMMRPPreference.GroupingType,
	   item.InventoryCD AS Sku,
	   comp.CompanyCD AS Company,
	   comp.CompanyCD AS Country,
	   insite.SiteCD  AS Warehouse,
	   invDetails.Date,
	   invDetails.Qty
FROM v_InventoryAllocationDetais invDetails
INNER JOIN Company comp  ON invDetails.CompanyID = comp.CompanyID
INNER JOIN INSite insite ON invDetails.CompanyID = insite.CompanyID
						AND invDetails.SiteID = insite.SiteID
INNER JOIN InventoryItem item ON invDetails.CompanyID = item.CompanyID
							 AND invDetails.InventoryID = item.InventoryID
INNER JOIN LUMMRPPreference ON invDetails.CompanyID = LUMMRPPreference.CompanyID
						   AND LOWER(invDetails.AllocationType) = LOWER(LUMMRPPreference.AllocationType)
WHERE invDetails.CompanyID > 0]]></CDATA>
</Sql>